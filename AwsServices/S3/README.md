# S3 Explained 
S3 is an AWS service that allows you to store any kind of data , and the data is stored in `buckets` (A bucket is a container for objects). 

S3 is an object storage, not a file system, that means all data in a bucket  will have: 

Object = Data + Metadata + Identifier (Key)

---
### Permissions in S3:

`s3:GetObject`

`s3:PutObject`

These are the same than `Read` and `Write` permissions.

---
### Object versioning
Object versioning is an AWS resource that allows multiple versions of the same object to be stored in a bucket.

When you active the Object Versioning:

- Each file sent to the bucket will receive a Key.

-  The resource keep the original object name. 

- Each version receive a Version ID automatically generated by S3

Example: 

You have file.txt:

- First upload > file.txt, Version ID: `1111`

- Second upload > file.txt, Version ID: `2222`

It may prevent that an attacker  can replace the source code 

How it works:
```bash
aws s3api get-object --bucket my-bucket --key file.txt --version-id 1111 file_old.txt
``` 
By default, when you download, you get the latest version of the object, but you can specify the version you want to download

---

### S3 Bucket Policy
A Bucket Policy allows you to define fine-grained permissions for an S3 bucket. It specifies who can access the bucket, what actions they can perform (like GetObject, PutObject), and under which conditions. This method is recommended over legacy ACLs for managing access control.

Example: 

```json 
{

    "Version": "2026-02-11",

    "Statement": [

        {

            "Sid": "PublicRead",

            "Effect": "Allow",

            "Principal": "*",

            "Action": [

                "s3:GetObject",

                "s3:PutObject"
            ],

            "Resource": [

                "arn:aws:s3:::my-bucket/*"

            ]
        }
    ]
}
```

This bucket policy allows anyone on the internet to upload or download files from the bucket.

___

## Amazon CloudFront
Amazon CloudFront is a Content Delivery Network (CDN) service from AWS. It helps deliver content (files, sites, videos, APIs) quickly and safely to users around the world.

`CloudFront can enforce access controls and encrypt sensitive data, ensuring only authorized users or systems can access it.` 

## CloudFront Origins
CloudFront can deliver content from almost any HTTP/HTTPS source, including S3 buckets, EC2 instances, API Gateway, Media Services, and even external web servers.

`For any content that is restricted, AWS expects you to block access directly at the origin using "Resource-Based Policy" restrictions or Security Group (Firewall) Rules and allow it to be served only through CloudFront.`

### Origin Access Identities (OAIs)
An OAI (Origin Access Identity) is a "virtual user" that you create in CloudFront to access a private S3 bucket. It ensures that no one can access the files directly through S3—only through CloudFront.

Example of an OAI within a bucket policy :
```json
           
{
     "Sid": "1", 
     "Effect": "Allow", 
     "Principal": { "AWS": "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity EAF5XXXXXXXXX" },
       "Action": "s3:GetObject",
       "Resource": "arn:aws:s3:::{your_bucket}/*" 
        }

```

---
## Misconfigured Origins & Bypass Techniques

If origins are not restricted, they may be accessed directly.

Common discovery techniques:

 - ### 1. Certificate Transparency Logs
   Using tools like crt.sh to identify subdomains.

 - ### 2. DNS Reconnaissance

   Using nslookup to identify whether:
   A domain resolves to CloudFront
   A domain resolves to EC2
   A domain exposes backend infrastructure

   ```bash
   nslookup example.com
   ```

 - ### 3. Public S3 Bucket Enumeration

   Common S3 URL formats:

   * https://bucket.s3.amazonaws.com
   * https://bucket.s3-region.amazonaws.com
   * https://bucket.s3-website.region.amazonaws.com


   If a bucket is public, attackers may:
   * List objects
   * Download sensitive files
   * Discover hidden content

---
## How to interact with a bucket:
```bash
aws s3 sync s3://{bucket-name} . --no-sing-request
```
This command will dump the S3 Bucket specified

`The --no-sign-request is a global option in the AWS CLI that disables the signing of HTTP requests to the AWS service endpoin`
```bash 
aws s3 ls s3://{bucket-name} --no-sing-request
```
---
### EC2 & S3 Misconfiguration – AMI Exposure Risk

`Scenario Overview`

In this scenario, an S3 bucket used to host static website assets also contained a backup of an EC2 virtual machine image (AMI).

Because the bucket was publicly accessible, the AMI file could be downloaded and restored into a new EC2 instance.

How to restore the image:
```bash
aws ec2 create-restore-image-task --object-key backups/webserver-backup-2024.bin  --bucket assets.example.com --name restored-webserver-image
 ```

If you restore an AMI and want to access the new instance via SSH, you need to associate a key pair at the time of run-instances.

```bash
aws ec2 create-key-pair --key-name {Key Name} --query "KeyMaterial" --output text > ~/.ssh/keys.pem
``` 

You will need of a subnet. The subnet must be public and associated with a route to an Internet Gateway for direct internet access

```bash
aws ec2 describe-subnets
``` 

And now a Security Group that allows inbound TCP traffic on port 22.
```bash
aws ec2 describe-security-groups
```

Launch your EC2 instance
```bash
aws ec2 run-instances --image-id {ID From Restore Image} --instance-type t3a.micro --key-name {Key Name} --subnet-id {Subnet ID} --security-group-id {Security group id}
```

After you launch the instance, you should see your new instance and the associated public IP address.

```bash
ssh -i "{Private_key}.pem" root@{EC2 Public IP Address}
``` 